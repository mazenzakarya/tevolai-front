<div class="page-header">
  <div>
    <h2>Users</h2>
    <p>Manage application users, roles, and passwords.</p>
  </div>
</div>

@if (errorMessage()) {
  <div class="alert alert-error">{{ errorMessage() }}</div>
}

<div class="grid grid-2">
  <div class="card">
    <h3>Create User</h3>
    <form [formGroup]="createForm" (ngSubmit)="createUser()" class="form">
      <div class="form-row">
        <div class="form-group">
          <label>Email *</label>
          <input type="email" formControlName="email" placeholder="user@email.com" />
        </div>
        <div class="form-group">
          <label>Username *</label>
          <input type="text" formControlName="userName" placeholder="username" />
        </div>
      </div>

      <div class="form-group">
        <label>Password *</label>
        <input type="password" formControlName="password" placeholder="******" />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" formControlName="firstName" />
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" formControlName="lastName" />
        </div>
      </div>

      <div class="form-group">
        <label>Phone</label>
        <input type="text" formControlName="phoneNumber" />
      </div>

      <button class="btn btn-primary" type="submit" [disabled]="createForm.invalid || isLoading()">
        @if (isLoading()) { Creating... } @else { Create }
      </button>
    </form>
  </div>

  <div class="card">
    <h3>Search by Email</h3>
    <form [formGroup]="searchForm" (ngSubmit)="searchByEmail()" class="form">
      <div class="form-row">
        <div class="form-group">
          <label>Email</label>
          <input type="email" formControlName="email" placeholder="user@email.com" />
        </div>
        <div class="actions">
          <button class="btn btn-outline" type="submit" [disabled]="isLoading()">Search</button>
          <button class="btn btn-outline" type="button" (click)="clearSearch()" [disabled]="isLoading()">Clear</button>
        </div>
      </div>
    </form>

    <h3 class="mt">Assign Role</h3>
    <form [formGroup]="roleForm" (ngSubmit)="submitRole()" class="form">
      <div class="form-row">
        <div class="form-group">
          <label>User Id *</label>
          <input type="text" formControlName="userId" placeholder="Select from table" />
        </div>
        <div class="form-group">
          <label>Role Name *</label>
          <input type="text" formControlName="roleName" placeholder="Admin / User ..." />
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" type="submit" [disabled]="roleForm.invalid || isLoading()">Assign</button>
        <button class="btn btn-outline" type="button" (click)="createRole()" [disabled]="!roleForm.value.roleName || isLoading()">Create Role</button>
      </div>
    </form>

    @if (resettingPasswordUserId()) {
      <h3 class="mt">Reset Password</h3>
      <form [formGroup]="resetPasswordForm" (ngSubmit)="submitResetPassword()" class="form">
        <div class="form-row">
          <div class="form-group">
            <label>New Password *</label>
            <input type="password" formControlName="newPassword" placeholder="******" />
          </div>
          <div class="actions">
            <button class="btn btn-primary" type="submit" [disabled]="resetPasswordForm.invalid || isLoading()">Reset</button>
            <button class="btn btn-outline" type="button" (click)="cancelResetPassword()" [disabled]="isLoading()">Cancel</button>
          </div>
        </div>
      </form>
    }
  </div>
</div>

<div class="card mt">
  <div class="table-header">
    <h3>All Users</h3>
    <button class="btn btn-outline" type="button" (click)="loadUsers()" [disabled]="isLoading()">Refresh</button>
  </div>

  @if (isLoading()) {
    <div class="spinner"></div>
  } @else {
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>Email</th>
            <th>Username</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Roles</th>
            <th class="actions-col">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (u of users(); track u.id) {
            <tr>
              <td>{{ u.email }}</td>
              <td>{{ u.userName }}</td>
              <td>{{ (u.firstName || '') + ' ' + (u.lastName || '') }}</td>
              <td>{{ u.phoneNumber || '-' }}</td>
              <td>{{ (u.roles || []).join(', ') || '-' }}</td>
              <td class="actions-col">
                <button class="btn btn-outline" type="button" (click)="startEdit(u)">Edit</button>
                <button class="btn btn-outline" type="button" (click)="assignRole(u)">Role</button>
                <button class="btn btn-outline" type="button" (click)="startResetPassword(u)">Reset</button>
                <button class="btn btn-outline danger" type="button" (click)="deleteUser(u)">Delete</button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>

@if (editingUserId()) {
  <div class="card mt">
    <h3>Edit User</h3>
    <form [formGroup]="editForm" (ngSubmit)="saveEdit()" class="form">
      <div class="form-row">
        <div class="form-group">
          <label>Email</label>
          <input type="email" formControlName="email" />
        </div>
        <div class="form-group">
          <label>Username</label>
          <input type="text" formControlName="userName" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" formControlName="firstName" />
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" formControlName="lastName" />
        </div>
      </div>

      <div class="form-group">
        <label>Phone</label>
        <input type="text" formControlName="phoneNumber" />
      </div>

      <div class="actions">
        <button class="btn btn-primary" type="submit" [disabled]="isLoading()">Save</button>
        <button class="btn btn-outline" type="button" (click)="cancelEdit()" [disabled]="isLoading()">Cancel</button>
      </div>
    </form>
  </div>
}


