<div class="email-credentials-page">
  <div class="page-header">
    <h2>Email Credentials</h2>
    <button class="btn btn-primary" (click)="openAddForm()">+ Add Credentials</button>
  </div>

  <!-- Customer Selection -->
  <div class="customer-selection card">
    <h3>Select Customer</h3>
    <select (change)="onCustomerChange($any($event.target).value)" class="customer-dropdown">
      <option value="">Select a customer to view credentials</option>
      @for (customer of customers(); track customer.id) {
      <option [value]="customer.id">
        {{ customer.fullName }}
      </option>
      }
    </select>
  </div>

  <!-- Credentials List -->
  @if (selectedCustomerId()) {
  <div class="credentials-list card">
    <h3>Email Credentials for {{ selectedCustomerName }}</h3>
    @if (getFilteredCredentials().length === 0) {
    <p>No email credentials found for this customer.</p>
    } @else {
    <div class="credentials-grid">
      @for (credential of getFilteredCredentials(); track credential.customerId) {
      <div class="credential-card">
        <div class="credential-header">
          <h4>{{ credential.emailAddress }}</h4>
          <div class="credential-actions">
            <button
              class="btn btn-outline btn-sm"
              (click)="togglePasswordVisibility(credential.id!)"
            >
              {{ isPasswordVisible(credential.id!) ? 'ü´£' : 'üëÅÔ∏è' }} 
            </button>
            <button class="btn btn-outline btn-sm" (click)="openEditForm(credential)">Edit</button>
            <button class="btn btn-danger btn-sm" (click)="deleteCredential(credential.id!)">
              Delete
            </button>
          </div>
        </div>
        <div class="credential-details">
          @if (isPasswordVisible(credential.id!) && (credential.password ||
          credential.decryptedPassword)) {
          <p>
            <strong>Password:</strong>
            {{ credential.decryptedPassword || credential.password || 'No password available' }}
          </p>
          } @if (credential.userName) {
          <p><strong>Username:</strong> {{ credential.userName }}</p>
          } @if (credential.hostingPlatform) {
          <p><strong>Hosting Platform:</strong> {{ credential.hostingPlatform }}</p>
          } @if (credential.notes) {
          <p><strong>Notes:</strong> {{ credential.notes }}</p>
          }
        </div>
      </div>
      }
    </div>
    }
  </div>
  }

  <div class="info-card card">
    <h3>Email Configuration</h3>
    <p>
      Configure email credentials for sending automated emails and notifications from your
      application.
    </p>
  </div>

  @if (showForm()) {
  <div class="modal-overlay" (click)="closeForm()">
    <div class="modal-content card" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ editingCredential() ? 'Edit Email Credentials' : 'Add Email Credentials' }}</h3>
        <button class="close-btn" (click)="closeForm()">√ó</button>
      </div>

      <form [formGroup]="credentialForm" (ngSubmit)="onSubmit()" class="credential-form">
        <!-- Customer -->
        <div class="form-group">
          <label>Customer *</label>
          <select
            formControlName="customerId"
            [class.error]="
              credentialForm.get('customerId')?.invalid && credentialForm.get('customerId')?.touched
            "
          >
            <option value="">Select Customer</option>
            @for (customer of customers(); track customer.id) {
            <option [value]="customer.id">
              {{ customer.fullName }}
            </option>
            }
          </select>
        </div>

        <!-- Email -->
        <div class="form-group">
          <label>Email Address *</label>
          <input
            type="email"
            formControlName="emailAddress"
            [class.error]="
              credentialForm.get('emailAddress')?.invalid &&
              credentialForm.get('emailAddress')?.touched
            "
          />
          @if (credentialForm.get('emailAddress')?.invalid &&
          credentialForm.get('emailAddress')?.touched) {
          <span class="error-text">Please enter a valid email address</span>
          }
        </div>

        <!-- Password -->
        <div class="form-group">
          <label>Password *</label>
          <input
            type="password"
            formControlName="password"
            [class.error]="
              credentialForm.get('password')?.invalid && credentialForm.get('password')?.touched
            "
          />
          @if (credentialForm.get('password')?.invalid && credentialForm.get('password')?.touched) {
          <span class="error-text">Password is required</span>
          }
        </div>

        <!-- Username -->
        <div class="form-group">
          <label>User Name</label>
          <input type="text" formControlName="userName" />
        </div>

        <!-- Hosting Platform -->
        <div class="form-group">
          <label>Hosting Platform</label>
          <input type="text" formControlName="hostingPlatform" />
        </div>

        <!-- Notes -->
        <div class="form-group">
          <label>Notes</label>
          <textarea formControlName="notes"></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-outline" (click)="closeForm()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="credentialForm.invalid">
            Save
          </button>
        </div>
      </form>
    </div>
  </div>
  }
</div>
